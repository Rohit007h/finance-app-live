<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinTrack Pro | Secure Login</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Outfit', 'sans-serif'] },
          colors: {
            glass: "rgba(255, 255, 255, 0.05)",
            glassBorder: "rgba(255, 255, 255, 0.1)",
            income: "#10b981",
            expense: "#ef4444"
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #000;
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .glass-panel {
      background: var(--glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glassBorder);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    /* Warning Animation for Budget Limit */
    .budget-warning {
        border: 2px solid #ef4444 !important;
        animation: pulse-red 2s infinite;
    }
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    .view-hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen">
  <div id="toast-container" class="flex flex-col gap-2 fixed top-5 right-5 z-50"></div>
  <div id="recaptcha-container"></div>

  <div id="auth-view" class="w-full max-w-md p-6 fade-in">
    <div class="glass-panel p-8 rounded-3xl border border-purple-500/30 relative overflow-hidden">
        <div class="relative z-10 text-center">
            <h1 class="text-3xl font-bold mb-2">FinTrack Pro</h1>
            <p class="text-gray-400 text-sm mb-6">Sign in to manage your wealth.</p>
            
            <div class="flex gap-2 mb-4 bg-black/40 p-1 rounded-xl">
                <button onclick="switchAuth('email')" id="tab-email" class="flex-1 py-2 rounded-lg text-xs font-bold bg-gray-800 text-white transition">Email</button>
                <button onclick="switchAuth('phone')" id="tab-phone" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition">Phone</button>
            </div>

            <div class="space-y-3">
                <button id="google-login-btn" class="w-full bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-100 transition flex items-center justify-center gap-3">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Continue with Google
                </button>
                
                <form id="email-auth-form" class="space-y-3" onsubmit="return false;">
                    <input type="email" id="auth-email" placeholder="Email address" class="w-full bg-[#0b0b0f]/50 border border-gray-700 text-white rounded-xl p-3 text-sm focus:border-purple-500 outline-none transition">
                    <input type="password" id="auth-pass" placeholder="Password" class="w-full bg-[#0b0b0f]/50 border border-gray-700 text-white rounded-xl p-3 text-sm focus:border-purple-500 outline-none transition">
                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <button type="button" id="email-login-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-semibold py-3 rounded-xl transition border border-gray-600">Log In</button>
                        <button type="button" id="email-signup-btn" class="bg-purple-600 hover:bg-purple-500 text-white font-semibold py-3 rounded-xl transition">Sign Up</button>
                    </div>
                </form>

                <form id="phone-auth-form" class="space-y-3 hidden" onsubmit="return false;">
                    <div id="phone-step-1">
                        <input type="tel" id="phone-number" placeholder="+91..." class="w-full bg-[#0b0b0f]/50 border border-gray-700 text-white rounded-xl p-3 text-sm focus:border-purple-500 outline-none transition mb-3">
                        <button type="button" id="send-otp-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-semibold py-3 rounded-xl transition">Send OTP</button>
                    </div>
                    <div id="phone-step-2" class="hidden">
                        <input type="text" id="otp-input" placeholder="123456" class="w-full bg-[#0b0b0f]/50 border border-gray-700 text-white rounded-xl p-3 text-center text-lg tracking-widest focus:border-purple-500 outline-none transition mb-3">
                        <button type="button" id="verify-otp-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-semibold py-3 rounded-xl transition">Verify & Login</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
  </div>

  <div id="app-view" class="w-full max-w-6xl p-4 md:p-8 view-hidden fade-in">
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">FinTrack <span class="text-xs border border-purple-500 px-2 py-0.5 rounded text-white ml-2">PRO</span></h1>
        </div>
        
        <div class="flex items-center gap-2">
            <button id="install-btn" class="hidden flex items-center gap-2 text-xs font-bold bg-blue-600 text-white px-4 py-2 rounded-full">
                <i class="fa-solid fa-download"></i> App
            </button>

            <a href="https://www.buymeacoffee.com/rohit1518" target="_blank" class="flex items-center gap-2 text-xs font-bold bg-[#FFDD00] hover:bg-[#ffc400] text-black px-4 py-2 rounded-full shadow-[0_0_15px_rgba(255,221,0,0.4)]">
                <i class="fa-solid fa-mug-hot"></i>
                <span class="hidden sm:inline">Support</span>
            </a>

            <button onclick="toggleUPI()" class="flex items-center gap-2 text-xs font-bold bg-teal-500 hover:bg-teal-400 text-black px-4 py-2 rounded-full shadow-[0_0_15px_rgba(20,184,166,0.4)]">
                <i class="fa-solid fa-qrcode"></i>
                <span class="hidden sm:inline">UPI</span>
            </button>
            
            <button onclick="downloadCSV()" class="text-xs bg-gray-800 border border-gray-700 px-4 py-2 rounded-full hover:bg-gray-700 transition"><i class="fa-solid fa-download"></i> CSV</button>
            <button onclick="signOut(auth)" class="text-xs text-red-400 border border-gray-700 px-3 py-2 rounded-full">Logout</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 space-y-6">
            
            <div id="balance-card" class="glass-panel p-6 rounded-2xl relative overflow-hidden">
                <p class="text-gray-400 text-sm uppercase tracking-wider">Total Balance</p>
                <h2 id="balance" class="text-4xl font-bold mt-2 text-white">‚Çπ 0.00</h2>
                
                <div class="mt-4 flex items-center gap-2 bg-black/30 p-2 rounded-lg border border-gray-700">
                    <i class="fa-solid fa-bell text-yellow-500 text-xs"></i>
                    <input type="number" id="budget-limit" placeholder="Set Monthly Budget..." onchange="updateUI()" class="bg-transparent text-xs text-white outline-none w-full" value="5000">
                </div>
                <p id="budget-alert" class="text-[10px] text-red-400 mt-1 hidden"><i class="fa-solid fa-triangle-exclamation"></i> Budget Exceeded!</p>

                <div class="flex justify-between mt-4 pt-4 border-t border-white/10">
                    <div><p class="text-xs text-gray-400">Income</p><p id="money-plus" class="text-income font-semibold">+‚Çπ0.00</p></div>
                    <div><p class="text-xs text-gray-400">Expense</p><p id="money-minus" class="text-expense font-semibold">-‚Çπ0.00</p></div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <h3 class="text-lg font-semibold mb-4">New Transaction</h3>
                <form id="form" class="space-y-4">
                    <input type="text" id="text" placeholder="Description" class="w-full bg-[#0b0b0f] border border-gray-700 text-white rounded-lg p-3 text-sm outline-none">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="amount" placeholder="Amount" class="w-full bg-[#0b0b0f] border border-gray-700 text-white rounded-lg p-3 text-sm outline-none">
                        <select id="type" class="w-full bg-[#0b0b0f] border border-gray-700 text-white rounded-lg p-3 text-sm outline-none">
                            <option value="expense">Expense</option><option value="income">Income</option>
                        </select>
                    </div>
                    
                    <select id="category" class="w-full bg-[#0b0b0f] border border-gray-700 text-white rounded-lg p-3 text-sm outline-none">
                        <option value="Pocket Money">üí∞ Pocket Money</option>
                        <option value="Food">üçî Food</option>
                        <option value="Travel">üöï Travel</option>
                        <option value="Shopping">üõçÔ∏è Shopping</option>
                        <option value="Recharge">üì± Recharge</option>
                        <option value="Bills">üßæ Bills</option>
                        <option value="Entertainment">üé¨ Entertainment</option>
                        <option value="Freelance">üíª Freelance</option>
                        <option value="Other">üì¶ Other</option>
                    </select>
                    
                    <button class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 rounded-lg shadow-lg">Add</button>
                </form>
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2"><i class="fa-solid fa-users text-teal-400"></i> Split Bill</h3>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="number" id="split-total" placeholder="Total ‚Çπ" class="bg-[#0b0b0f] border border-gray-700 text-white rounded p-2 text-xs w-full">
                    <input type="number" id="split-people" placeholder="People" class="bg-[#0b0b0f] border border-gray-700 text-white rounded p-2 text-xs w-full">
                </div>
                <button onclick="calculateSplit()" class="w-full bg-gray-800 text-xs py-2 rounded border border-gray-700 hover:bg-gray-700">Calculate</button>
                <div id="split-result" class="hidden mt-2 text-center">
                    <p class="text-teal-400 font-bold text-lg" id="split-amount">‚Çπ0</p>
                    <button onclick="shareWhatsapp()" class="text-[10px] text-green-400"><i class="fa-brands fa-whatsapp"></i> Share</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="glass-panel p-6 rounded-2xl min-h-[400px]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Transactions</h3>
                    <select id="date-filter" onchange="updateUI()" class="bg-[#0b0b0f] border border-gray-700 text-xs text-white rounded-lg px-3 py-1 outline-none">
                        <option value="all">All Time</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <ul id="list" class="space-y-3"></ul>
                <div id="empty-state" class="hidden text-center text-gray-500 mt-10"><p class="text-xs">No transactions found.</p></div>
            </div>
        </div>
    </div>
  </div>

  <div id="upi-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 hidden" onclick="toggleUPI()">
    <div class="glass-panel p-8 rounded-3xl max-w-sm w-full mx-4 text-center" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Scan to Pay</h3>
        <img src="qr.png" class="w-48 h-48 object-contain mx-auto bg-white rounded-lg mb-4">
        <code class="text-teal-400 text-sm block mb-2">rohit1518@oksbi</code>
        <button onclick="navigator.clipboard.writeText('rohit1518@oksbi')" class="text-xs text-gray-400">Click to Copy</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBay1fKl79jdAQEPgrmDPEDk_EE41nZLKw",
      authDomain: "fintrack-pro-cd015.firebaseapp.com",
      projectId: "fintrack-pro-cd015",
      storageBucket: "fintrack-pro-cd015.firebasestorage.app",
      messagingSenderId: "796478831338",
      appId: "1:796478831338:web:12b62b96939b304a08f593"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    let allTransactions = [];
    window.auth = auth;
    window.signOut = signOut;

    // AUTH SWAP LOGIC
    window.switchAuth = (type) => {
        document.getElementById('email-auth-form').classList.toggle('hidden', type !== 'email');
        document.getElementById('phone-auth-form').classList.toggle('hidden', type !== 'phone');
        document.getElementById('tab-email').className = type === 'email' ? 'flex-1 py-2 rounded-lg text-xs font-bold bg-gray-800 text-white transition' : 'flex-1 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition';
        document.getElementById('tab-phone').className = type === 'phone' ? 'flex-1 py-2 rounded-lg text-xs font-bold bg-gray-800 text-white transition' : 'flex-1 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition';
    }

    onAuthStateChanged(auth, (user) => {
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        if (user) {
            authView.classList.add('view-hidden');
            appView.classList.remove('view-hidden');
            loadData(user);
        } else {
            authView.classList.remove('view-hidden');
            appView.classList.add('view-hidden');
        }
    });

    document.getElementById('google-login-btn').addEventListener('click', () => signInWithPopup(auth, googleProvider));
    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    document.getElementById('email-login-btn').addEventListener('click', () => {
        signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-pass').value).catch(e => alert(e.message));
    });
    document.getElementById('email-signup-btn').addEventListener('click', () => {
        createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-pass').value).then(() => alert("Account Created!")).catch(e => alert(e.message));
    });

    function loadData(user) {
        const q = query(collection(db, "transactions"), where("uid", "==", user.uid), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateUI();
        });
    }

    // --- MAIN LOGIC (UPDATED WITH ICONS & FILTER) ---
    function getIcon(c) {
        const icons = {
            'Pocket Money': 'üí∞', 'Food': 'üçî', 'Travel': 'üöï', 'Shopping': 'üõçÔ∏è',
            'Recharge': 'üì±', 'Bills': 'üßæ', 'Entertainment': 'üé¨', 'Freelance': 'üíª', 'Other': 'üì¶'
        };
        return icons[c] || 'üì¶';
    }

    window.updateUI = () => {
        const filter = document.getElementById('date-filter').value;
        const budget = parseFloat(document.getElementById('budget-limit').value) || 0;
        const list = document.getElementById('list');
        list.innerHTML = '';

        let displayData = allTransactions;
        const now = new Date();
        if(filter === 'month') {
            displayData = allTransactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
        }

        document.getElementById('empty-state').classList.toggle('hidden', displayData.length > 0);

        let total = 0, inc = 0, exp = 0;
        const categories = {};

        displayData.forEach(t => {
            total += t.amount;
            if(t.amount > 0) inc += t.amount; else exp += t.amount;
            if(t.amount < 0) categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);

            const color = t.amount < 0 ? 'text-expense' : 'text-income';
            list.innerHTML += `
                <li class="flex justify-between items-center bg-[#0b0b0f] p-3 rounded-lg border-l-4 ${t.amount<0?'border-red-500':'border-green-500'}">
                    <div class="flex items-center gap-3">
                        <div class="h-8 w-8 rounded-full bg-gray-800 flex items-center justify-center text-sm">${getIcon(t.category)}</div>
                        <div><p class="font-bold text-sm">${t.text}</p><p class="text-[10px] text-gray-500">${t.dateDisplay}</p></div>
                    </div>
                    <div><span class="${color} font-bold text-sm">‚Çπ${Math.abs(t.amount)}</span>
                    <button onclick="deleteTransaction('${t.id}')" class="text-[10px] text-red-400 block text-right">Del</button></div>
                </li>`;
        });

        document.getElementById('balance').innerText = `‚Çπ${total.toFixed(2)}`;
        document.getElementById('money-plus').innerText = `+‚Çπ${inc.toFixed(2)}`;
        document.getElementById('money-minus').innerText = `-‚Çπ${Math.abs(exp).toFixed(2)}`;

        // Budget Alert
        const card = document.getElementById('balance-card');
        const alertMsg = document.getElementById('budget-alert');
        if(Math.abs(exp) > budget && budget > 0) {
            card.classList.add('budget-warning');
            alertMsg.classList.remove('hidden');
        } else {
            card.classList.remove('budget-warning');
            alertMsg.classList.add('hidden');
        }
        updateChart(categories);
    };

    function updateChart(data) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(data),
                datasets: [{ data: Object.values(data), backgroundColor: ['#a855f7', '#ec4899', '#3b82f6', '#10b981', '#f59e0b'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' }
        });
    }

    document.getElementById('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = document.getElementById('text').value;
        const amount = document.getElementById('amount').value;
        if(!text || !amount) return;
        let amtValue = +amount;
        if(document.getElementById('type').value === 'expense') amtValue = -Math.abs(amtValue);

        await addDoc(collection(db, "transactions"), {
            text, amount: amtValue, category: document.getElementById('category').value,
            date: new Date().toISOString(),
            dateDisplay: new Date().toLocaleDateString(),
            uid: auth.currentUser.uid
        });
        document.getElementById('text').value = ''; document.getElementById('amount').value = '';
    });

    window.deleteTransaction = async (id) => await deleteDoc(doc(db, "transactions", id));

    window.calculateSplit = () => {
        const total = parseFloat(document.getElementById('split-total').value);
        const people = parseInt(document.getElementById('split-people').value);
        if(!total || !people) return;
        document.getElementById('split-amount').innerText = `‚Çπ${(total/people).toFixed(2)}`;
        document.getElementById('split-result').classList.remove('hidden');
    }
    
    window.shareWhatsapp = () => {
        const amt = document.getElementById('split-amount').innerText;
        window.open(`https://wa.me/?text=Split Bill: We each owe ${amt}`, '_blank');
    }
    window.toggleUPI = () => document.getElementById('upi-modal').classList.toggle('hidden');
    window.downloadCSV = () => {
        let csv = "Description,Amount,Date\n" + allTransactions.map(t => `${t.text},${t.amount},${t.dateDisplay}`).join("\n");
        const a = document.createElement('a'); a.href = encodeURI("data:text/csv;charset=utf-8,"+csv); a.download="data.csv"; a.click();
    };
    window.filterList = () => {
        const term = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('li').forEach(el => el.style.display = el.innerText.toLowerCase().includes(term) ? 'flex' : 'none');
    };

    // PWA
    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.classList.remove('hidden');
    });
    installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.classList.add('hidden');
    });
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  </script>
</body>
</html>
